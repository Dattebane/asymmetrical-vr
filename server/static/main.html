<html>
  <head>
    <meta charset="utf-8">
    <title>Asymmetrical Aframe - WIP</title>
    <meta name="description" content="Asymmetrical Aframe - WIP">

    <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.13.1/dist/aframe-extras.min.js"></script>
    <script src="/resources/player.component.js"></script>
    <script src="/resources/user-count.component.js"></script>
    <script>window.NAF || document.write('<script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js">\x3C/script>')</script>
    <script src="https://unpkg.com/aframe-maze-component@0.1.24/dist/aframe-maze-component.min.js"></script>

  </head>

  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <a-scene networked-scene="
      room: dev;
      debug: true;
      adapter: wseasyrtc;
    ">

      <a-assets>
        <img id="sky" src="https://img.gs/bbdkhfbzkk/2048x2048,stretch/http://i.imgur.com/WqlqEkq.jpg" crossorigin="anonymous"/>
        <img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous"/>
        <img src="https://img.gs/bbdkhfbzkk/2048x1024,stretch/http://i.imgur.com/WMNH2OF.jpg" id="chrome" crossorigin="anonymous">

        <!-- Mouse model -->
          <a-asset-item id="mouse" kinematic-body src="/resources/mouse/scene.gltf"></a-asset-item>



        <!-- Maze -->
          <a-box static-body id="wall-one" 
            color="#444444" 
            depth="1" width="4" height="5" shadow></a-box>

          <a-cylinder id="end-cap"
            static-body color="silver" 
            depth="1.5" width="1.5" height="5.1"
            radius="0.6"></a-cylinder>

        <!-- Avatar -->
          <template id="mouse-template">
            <a-entity class="avatar" kinematic-body rotation=".5 .5 .5" scale=".3 .3 .3" gltf-model="#mouse"></a-entity> <!-- userHeight:.01 -->
          </template>

          <template id="god-template">
            <a-entity class="avatar"> <!-- userHeight:30 -->
              <a-sphere></a-sphere>
            </a-entity>
          </template>

          <template id="simple">
            <a-sphere></a-sphere>
          </template>

          <template id="maze-template">
            <a-entity maze='size: 10 10; cap: #end-cap; wall: #wall-one; open: W 5 E 5;' position='-30 2.5 -5'></a-entity>
          </template>

          <template id="data-template">
            <a-entity user-count></a-entity>
          </template>
      </a-assets>

      <a-entity id="player" kinematic-body player="playerType: GOD" look-controls raycaster camera="userHeight:.5" universal-controls></a-entity>
      
      <div id="maze-container">
        <!-- <a-entity id="maze" networked="template:#maze-template; attachTemplateToLocal:true"></a-entity> -->
      </div>

      <a-entity id="data" user-count="0" networked="template:#data-template"></a-entity>

      <a-entity
        geometry="primitive: plane; width: 10000; height: 10000;" static-body rotation="-90 0 0" position="0 -1 0"
        material="src: #grid; repeat: 10000 10000; transparent: true;metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"></a-entity>

      <a-sky src="#sky" rotation="0 -90 0"></a-sky>

      <!-- <a-entity persist-entity id="maze">
        <a-entity 
            maze='size: 10 10; cap: #end-cap; wall: #wall-one; open: W 5 E 5;' 
            position='-30 2.5 -5'>
            </a-entity>
      </a-entity> -->

      <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
      <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>
      <a-entity light="color: white; intensity: 0.5" position="-5 5 15"></a-entity>
      <a-entity light="color: white; type: ambient;"></a-entity>

    </a-scene>

    <script>
      
      NAF.schemas.add({
        template: '#mouse-template',
        components: [
          'position',
          {
            component: 'rotation',
            property: 'y'
          },
        ]
      });
      
      NAF.schemas.add({
        template: '#maze-template',
        components: [
          'position',
          'rotation',
          'maze',
        ]
      });

      NAF.schemas.add({
        template: '#data-template',
        components: [
          'user-count'
        ]
      });


      sceneEl = document.querySelector('a-scene');
      userCount = Number(sceneEl.querySelector('#data').getAttribute("user-count"));

      mazePresent = document.getElementById("maze");
      window.onLoad = syncMaze();
      console.log(mazePresent == true);
      function syncMaze() {
        if (mazePresent) {
          return;
        } else {
  
          var sceneEl = document.querySelector('a-scene');
          var maze = document.createElement('a-entity');
          maze.setAttribute('networked', 'template:#maze-template; attachTemplateToLocal:true');
          maze.setAttribute('id', 'maze');
          sceneEl.appendChild(maze);
          sceneEl.querySelector('#data').setAttribute("user-count", userCount++);
          console.log(Number(sceneEl.querySelector('#data').getAttribute("user-count")));

        }  
      }
    </script>
  </body>
</html>
